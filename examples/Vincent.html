<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>
<script src="js/mizzy.js" type="application/javascript"></script>
<script src="js/scream.js" type="application/javascript"></script>
<script>

	console.log(Scream);

	var Audio = new (window.AudioContext || window.webkitAudioContext)();


	var vincent = new Scream.Synths.Vincent(Audio, 16, "sawtooth", 60);
	vincent.addEffect(Scream.Effects.Filter);
	vincent.addEffect(Scream.Effects.Delay);
	vincent.addEffect(Scream.Effects.Reverb);
	vincent.attack = 0;
	vincent.decay = 0.01;
	vincent.release = 0.001;
	vincent.connectEffects();

	var fft = new Scream.Effects.FFT(Audio);
	fft.connect(Audio.destination);
	fft.draw();

	vincent.connect(fft.input);

	var m = new Mizzy();
	m.initialize().then(() => {
		m.bindToAllInputs();
		m.bindKeyboard();
		m.keyToggle((e) => {
			vincent.NoteOn(e);
		}, (e) => {
			vincent.NoteOff(e);
		});


		m.onCC(0, (e) => {
			vincent.output.gain.value = e.ratio;
		});
		m.onCC(1, (e) => {
			vincent.effects[0].effect.frequency.value = 50 + (e.ratio * 8000)
		});
		m.onCC(2, (e) => {
			vincent.wideness = e.ratio * 300;
		});
		m.onCC(3, (e) => {

		});
		m.onCC(4, (e) => {
			vincent.effects[0].effect.frequency.value = 40 + (e.ratio * 7600);
		});
		m.onCC(5, (e) => {
			vincent.effects[0].effect.Q.value = 100 * e.ratio;
		});
		m.onCC(6, (e) => {

		});
		m.onCC(7, (e) => {

		});
		m.onCC(8, (e) => {
			vincent.effects[1].effect.delayTime.value = e.ratio;
		});
		m.onCC(9, (e) => {
			vincent.effects[1].filter.effect.frequency.value = 160 + e.ratio * 1500;
		});
		m.onCC(10, (e) => {
			vincent.effects[1].filter.effect.Q.value = e.ratio;
		});
		m.onCC(11, (e) => {
			vincent.effects[1].feedback.gain.value = e.ratio * 1.1;
		});
		var decayTime = setTimeout(() => {
		}, 0);
		m.onCC(12, (e) => {
			clearTimeout(decayTime);
			decayTime = setTimeout(() => {
				vincent.effects[2].decayTime = e.ratio * 8;
			}, 100);
		});
		m.onCC(13, (e) => {
			vincent.effects[2].wet.gain.value = e.ratio;
		});
		m.onCC(14, (e) => {
			vincent.effects[2].dry.gain.value = e.ratio;
		});
		m.onCC(15, (e) => {
			m.clock.BPM = 40 + (e.ratio * 140);
			vincent.effects[1].effect.delayTime.value = (60000 / m.clock.BPM);
		});
		for (let i = 16; i < 16 + 16; i++) {
			m.onCC(i, (e) => {
				sequenceNote(i, e)
			});
		}
	});

	var sequence_length = 16;

	function sequenceNote (i, value) {
		if (value > 0) {
			sequence[i] = Mizzy.Generate.NoteOn(value, 127);
		} else {
			sequence[i] = Mizzy.Generate.NoteOff(sequence[i][1]);
		}

	}

	var sequence = new Array(16);

	function processTick (loopIndex) {
		if (sequence[loopIndex] != undefined) {
			var message = sequence[loopIndex];
			var event = Mizzy.Generate.MidiEvent(message, "C");
			m.sendMidiMessage(event);
			setTimeout(() => {
				let noteoff = Mizzy.Generate.NoteOff(message[1], 127);
				let e = Mizzy.Generate.MidiEvent(noteoff, "C");
				m.sendMidiMessage(e);
			}, (60000 / m.clock.BPM) * 0.5);
		}
	}

	sequenceNote(0, 72);
	sequenceNote(4, 60);
	sequenceNote(8, 68);
	sequenceNote(12, 64);


	m.clock.on("tick", (tick) => processTick(tick.loopIndex));


	window.addEventListener("keydown", (e) => {
		switch (e.keyCode) {
			case 192:
				if (m.clock.playing) {
					m.clock.stop();
				} else {
					m.clock.play();
				}
				break;
		}
	});


	var CanvasContainer = document.createElement("div");
	document.getElementsByTagName("body")[0].appendChild(CanvasContainer);
	fft.addToElement(CanvasContainer);
</script>
</body>
</html>